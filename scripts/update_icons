#!/usr/bin/env python3
import argparse
import re
import unicodedata
import urllib.request
from pathlib import Path

DEFAULT_CSS_URL = "https://jslegers.github.io/emoji-icon-font/style.css"
DEFAULT_OUTPUT_PATH = "crates/numelace-app/src/ui/icon.rs"


ICON_REGEX = re.compile(
    r"\.icon-([A-Za-z0-9-]+):before\s*\{\s*content:\s*\"\\([0-9a-fA-F]+)\"\s*;\s*\}"
)


def to_const_name(icon_name: str) -> str:
    parts = icon_name.replace("-", "_").split("_")
    out_parts = []
    for part in parts:
        if not part:
            continue
        if any(c.isalpha() and c.isupper() for c in part):
            out_parts.append("UPPER")
            out_parts.append(part.upper())
        else:
            out_parts.append(part.upper())
    return "_".join(out_parts)


def fetch_css(url: str) -> str:
    with urllib.request.urlopen(url) as response:
        return response.read().decode("utf-8")


def generate_icon_rs(css_text: str, source_url: str) -> str:
    matches = list(ICON_REGEX.finditer(css_text))
    if not matches:
        raise ValueError("No icons found in CSS. The upstream format may have changed.")

    lines = [
        "// icons from emoji-icon-font",
        "// https://jslegers.github.io/emoji-icon-font/",
        f"// Source CSS: {source_url}",
        "//",
        "// This file is @generated by `scripts/update_icons`.",
        "// Do not edit by hand. Run the script to update.",
        "#![allow(dead_code)]",
        "",
    ]

    for match in matches:
        icon_name = match.group(1)
        code_hex = match.group(2)
        codepoint = int(code_hex, 16)
        char = unicodedata.normalize("NFC", chr(codepoint))
        const_name = to_const_name(icon_name)
        lines.append(f'pub const {const_name}: &str = "{char}";')

    lines.append("")
    return "\n".join(lines)


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Regenerate emoji icon constants from upstream CSS."
    )
    parser.add_argument(
        "--css-url",
        default=DEFAULT_CSS_URL,
        help="URL to emoji-icon-font style.css",
    )
    parser.add_argument(
        "--output",
        default=DEFAULT_OUTPUT_PATH,
        help="Path to write icon.rs (relative to repo root)",
    )
    return parser.parse_args()


def main() -> int:
    args = parse_args()
    css_text = fetch_css(args.css_url)
    icon_rs = generate_icon_rs(css_text, args.css_url)

    repo_root = Path(__file__).resolve().parent.parent
    output_path = Path(args.output)
    if not output_path.is_absolute():
        output_path = repo_root / output_path
    output_path.write_text(icon_rs, encoding="utf-8")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
